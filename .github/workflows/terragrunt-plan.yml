name: terragrunt plan

on:
  pull_request:
    branches: [ "main" ]
    types: [opened, synchronize, reopened]
    paths:
      - '**/*.tf'
      - '**/*.hcl'
      - '.github/workflows/terragrunt-plan.yml'
  workflow_dispatch:
    inputs:
      environment:
        description: "Target environment"
        required: true
        type: choice
        options:
          - dev
          - stg
          - prd
        default: dev

env:
  aws_default_region: ap-northeast-1
  tg_version: 0.99.1
  tf_version: 1.14.5
  deploy_env: ${{ github.event.inputs.environment || 'dev' }}
  TF_PLUGIN_CACHE_DIR: ${{ github.workspace }}/.terraform.d/plugin-cache
  ACTIONS_RUNNER_DEBUG: true
  ACTIONS_STEP_DEBUG: true

permissions:
  id-token: write
  contents: read
  pull-requests: write

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  terragrunt-plan:
    runs-on: ubuntu-latest
    environment: ${{ github.event.inputs.environment || 'dev' }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@00943011d9042930efac3dcd3a170e4273319bc8 # v4
        with:
          aws-region: ${{ env.aws_default_region }}
          role-to-assume: ${{ secrets.AWS_GITHUB_ACTIONS_OIDC_ROLE_ARN }}

      - name: Create Terraform Plugin Cache Dir
        run: mkdir -p ${{ env.TF_PLUGIN_CACHE_DIR }}

      - name: Terraform Plugin Cache
        uses: actions/cache@v5
        with:
          path: ${{ env.TF_PLUGIN_CACHE_DIR }}
          key: ${{ runner.os }}-terraform-plugin-cache-${{ github.sha }}

      - name: Terragrunt plan
        id: tg_plan
        uses: gruntwork-io/terragrunt-action@v3
        env:
          TF_PLUGIN_CACHE_DIR: ${{ env.TF_PLUGIN_CACHE_DIR }}
        with:
          tf_version: ${{ env.tf_version }}
          tg_version: ${{ env.tg_version }}
          tg_dir: infra/terragrunt/live/${{ env.deploy_env }}
          tg_command: run --all plan
          tg_comment: 0
          tg_add_approve: 0

      - name: Save plan log
        if: always()
        shell: bash
        run: |
          raw='${{ steps.tg_plan.outputs.tg_action_output }}'
          printf '%s' "$raw" | sed 's/%0A/\n/g' > terragrunt-plan.log

      - name: Upload plan log artifact
        id: upload_plan_log
        if: always()
        uses: actions/upload-artifact@v5
        with:
          name: terragrunt-plan-${{ env.deploy_env }}-${{ github.sha }}
          path: terragrunt-plan.log
          retention-days: 14

      - name: Build PR comment body
        if: always()
        shell: bash
        run: |
          RAW='${{ steps.tg_plan.outputs.tg_action_output }}'
          PLAN_DECODED=$(printf '%b' "${RAW//%0A/\\n}")

          cat > pr-comment.md <<EOF
          <!-- terragrunt-plan -->
          ### :seedling: Terragrunt Plan (env: **${{ env.deploy_env }}**)
          **Status**: ${{ steps.tg_plan.outcome }}
          **Log**: [ğŸ“¦ terragrunt-plan log](${{ steps.upload_plan_log.outputs.artifact-url }})
          
          <details><summary>Show plan output</summary>
          
          \`\`\`terraform
          $PLAN_DECODED
          \`\`\`
          </details>
          EOF

      - name: Post / update comment
        if: github.event_name == 'pull_request'
        env:
          GH_TOKEN: ${{ github.token }}
        shell: bash
        run: |
          # ç›´è¿‘ã‚³ãƒ¡ãƒ³ãƒˆãŒç„¡ã‘ã‚Œã° exit 1 â†’ || ã§æ–°è¦æŠ•ç¨¿
          gh pr comment ${{ github.event.pull_request.number }} \
            --body-file pr-comment.md --edit-last \
          || gh pr comment ${{ github.event.pull_request.number }} \
            --body-file pr-comment.md
